---
description: KR-AI-Engine Development Guidelines
globs:
alwaysApply: true
---

# ğŸš€ KR-AI-Engine Development Guidelines

## ğŸ“‹ **WICHTIGE REGELN FÃœR DIE IMPLEMENTIERUNG:**

### **ğŸ”„ DATA FLOW REGELN (KRITISCH!):**

#### **1. Processing Pipeline Reihenfolge (NIEMALS Ã„NDERN!):**
```
1. ğŸ“¤ Upload Processor â†’ krai_core.documents (Database only)
2. ğŸ“„ Text Processor â†’ krai_content.chunks + krai_intelligence.chunks  
3. ğŸ–¼ï¸ Image Processor â†’ krai_content.images (Object Storage)
4. ğŸ·ï¸ Classification Processor â†’ krai_core.manufacturers, products, product_series
5. ğŸ“‘ Metadata Processor â†’ krai_intelligence.error_codes
6. ğŸ’¾ Storage Processor â†’ Cloudflare R2 (NUR Bilder)
7. ğŸ”ª Text Chunking â†’ krai_intelligence.chunks
8. ğŸ”® Embedding Processor â†’ krai_intelligence.embeddings
9. âœ… Finalization â†’ krai_system.processing_queue
```

#### **2. Storage Rules (NIEMALS VERLETZEN!):**
- **Dokumente**: âŒ KEIN Object Storage (nur Database)
- **Dokument-Bilder**: âœ… krai-document-images Bucket
- **Fehler-Bilder**: âœ… krai-error-images Bucket (Defect Detection)
- **Teile-Bilder**: âœ… krai-parts-images Bucket

#### **3. Error Handling (STRENG!):**
- **Fehler = Stopp** (keine Retries)
- **Immer Loggen** fÃ¼r Debugging
- **Rollback** bei Fehlern
- **Sequential Processing** bei hohem Load

#### **4. Features Inheritance (WICHTIG!):**
- **Serie-Features** â†’ `product_series.key_features` (JSONB)
- **Produkt-Features** â†’ `products.*_capable` (BOOLEAN)
- **Automatische Vererbung**: Serie â†’ Produkt
- **Features API** fÃ¼r Management

### **ğŸ¤– AI MODEL REGELN:**

#### **1. Hardware Detection (AUTOMATISCH!):**
- **RTX 2000 + 8GB VRAM** â†’ HIGH_PERFORMANCE Tier
- **GPU Acceleration** â†’ Immer aktiviert wenn verfÃ¼gbar
- **Modell-Auswahl** â†’ Basierend auf Hardware
- **Task-spezifische Zuordnung** â†’ Richtiges Modell fÃ¼r jede Aufgabe

#### **2. Ollama Integration:**
- **Text Classification**: llama3.2:latest (2.0 GB)
- **Embeddings**: embeddinggemma:latest (621 MB)
- **Vision**: llava:latest (4.7 GB)
- **GPU Support** â†’ Immer nutzen wenn verfÃ¼gbar

### **ğŸ—„ï¸ DATABASE REGELN:**

#### **1. Schema Mapping (EXAKT!):**
- **krai_core**: manufacturers, products, product_series, documents
- **krai_content**: chunks, images, print_defects
- **krai_intelligence**: chunks, embeddings, error_codes, search_analytics
- **krai_system**: processing_queue, audit_log, system_metrics

#### **2. Supabase Integration:**
- **MCP Server** â†’ FÃ¼r Database Connection
- **Vector Extensions** â†’ pgvector fÃ¼r Embeddings
- **RLS Policies** â†’ Sicherheit
- **Performance Indexes** â†’ Optimierung

### **â˜ï¸ OBJECT STORAGE REGELN:**

#### **1. Cloudflare R2 (NUR Bilder!):**
- **krai-document-images** â†’ Aus Dokumenten extrahierte Bilder
- **krai-error-images** â†’ Defect Detection Bilder
- **krai-parts-images** â†’ Parts Catalog Bilder
- **Deduplication** â†’ File Hash basiert

#### **2. Bucket Management:**
- **Automatische Erstellung** â†’ Falls nicht vorhanden
- **Organized Structure** â†’ images/YYYY/MM/filename
- **Metadata Storage** â†’ Database nur, nicht R2

### **ğŸ”§ IMPLEMENTATION REGELN:**

#### **1. Module Structure (EXAKT!):**
```
backend/
â”œâ”€â”€ config/ai_config.py          # Hardware Detection + Model Config
â”œâ”€â”€ core/base_processor.py       # Base Interface
â”œâ”€â”€ processors/                  # 8 spezialisierte Prozessoren
â”œâ”€â”€ services/                    # Database, Storage, AI Services
â”œâ”€â”€ utils/                       # Chunk, Pattern, Image Utils
â””â”€â”€ api/                         # FastAPI Endpoints
```

#### **2. Configuration Files (WICHTIG!):**
- **chunk_settings.json** â†’ Text Chunking Strategies
- **error_code_patterns.json** â†’ Error Code Patterns
- **version_patterns.json** â†’ Version Extraction
- **model_placeholder_patterns.json** â†’ Model Placeholders

#### **3. Resource Management:**
- **Low Resource**: upload, metadata, storage (1-2 Instanzen)
- **Medium Resource**: text, classification, search (2-3 Instanzen)
- **High Resource**: image, embedding (3-5 Instanzen)
- **Load Balancing** â†’ Basierend auf Resource Usage

### **ğŸš¨ KRITISCHE FEHLER VERMEIDEN:**

#### **1. NIEMALS:**
- Dokumente in Object Storage speichern
- Data Flow Reihenfolge Ã¤ndern
- GPU-Support ignorieren
- Error Handling umgehen
- Features Inheritance vergessen

#### **2. IMMER:**
- Hardware Detection beim Start
- GPU Acceleration nutzen
- Error = Stopp + Logging
- Database-only fÃ¼r Dokumente
- Object Storage nur fÃ¼r Bilder

#### **3. VALIDATION:**
- File Hash fÃ¼r Deduplication
- Model Placeholder Resolution
- Version Detection fÃ¼r Updates
- Pattern Matching fÃ¼r Error Codes
- Chunking basierend auf Document Type

### **ğŸ“Š SUCCESS METRICS:**
- **Processing Speed** â†’ GPU-optimiert
- **Storage Efficiency** â†’ Keine Duplikate
- **Search Quality** â†’ Vector Embeddings
- **Error Detection** â†’ Pattern Matching
- **Features Accuracy** â†’ AI Classification

---

**ğŸ¯ ZIEL: Perfekte Implementierung ohne Fehler!**
